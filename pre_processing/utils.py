import os, array
import numpy as np
import imageio


def make_byteplot_im(path, name):
    with open(path, 'rb') as f:
        ln = os.path.getsize(path)  # length of file in bytes
        width = int(ln**(1/2))
        rem = ln % width
        a = array.array("B")  # uint8 array
        a.fromfile(f, ln-rem)

    g = np.reshape(a, (int(len(a)/width), width))
    g = np.uint8(g)
    output_path = "C:/Users/rotem/Documents/Malware detection/Malware-Detection/data/benign_compressed/"
    imageio.imsave(output_path + name + '.png', g, compression=True)


def create_benign_imgset():
    created = 0
    failed = 0
    i = 0
    for path, subdirs, files in os.walk("C:/"):
        for name in files:
            if name.endswith("exe"):
                try:
                    make_byteplot_im(os.path.join(path, name), name+str(i))
                    i += 1
                    created += 1
                except:
                    failed += 1
                    continue
    print("Finished creating benign imgset with {} total images and {} failures".format(created, failed))


if __name__ == "__main__":
    create_benign_imgset()
    # make_byteplot_im("C:\Program Files\Oracle\VirtualBox\VirtualBox.exe", "VirtualBox.exe")